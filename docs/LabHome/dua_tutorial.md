---
layout: default
title: Data Use Agreements Tutorial
parent: Lab Basics
has_toc: true
nav_order: 11
---

ðŸ‘‹ If you need to download some data from the [NIMH Data Arhive](https://nda.nih.gov/) but do not have access to it, you've come to the right place!



# Creating a Data Use Agreement for NIMH Datasets

_Note: This tutorial uses the [PING](https://nda.nih.gov/edit_collection.html?id=2607) dataset as an example for illustration purposes._

You will need a valid [PennKey](https://pennkeysupport.upenn.edu/) in order to create a new data use agreement.

## Getting started : Download and fill out the most up-to-date form

You can access the most recent version [here](https://nda.nih.gov/about/forms.html). Make sure that you select **Data Use Certification (DUC)** to download the form.

<img width="638" alt="zero-step" src="https://user-images.githubusercontent.com/53891017/127577597-6a126d78-a706-4c61-a1a5-735e2eab46ca.png">

Next, you need to fill out the form (don't forget to add yourself as a recipient), and have Ted sign it.

 
## Step 1 : Enter the RIS 

[Research Inventory System](https://researchinventory.apps.upenn.edu/researchInventory/jsp/fast2.do?bhcp=1) is the web-based application for requesting, routing, and issuing various research related agreements.

Start by clicking on the system and providing your PennKey login. You should then see the following:

<img width="841" alt="first-step" src="https://user-images.githubusercontent.com/53891017/127496253-2a1c4978-9f42-49e6-9ce5-204150536a6a.png">


## Step 2 : Create new data request

Go to **DATA: If you want to receive/send data for research from/to an outside party, click <ins>here</ins>** and click <ins>here</ins>.

<img width="848" alt="third-step" src="https://user-images.githubusercontent.com/53891017/127526206-1a42661a-9556-441a-aebc-d25dc149a028.png">

> **Are you receiving or are you sending data?**

Since we are requesting data access, we select _receiving_.

> Type of data

In the case of [PING](https://nda.nih.gov/edit_collection.html?id=2607), the type of data is "de-identified health information".

> Please provide brief description of data

Please provide basic description of your requested dataset.

> Can the data be obtained from an alternative source?

In the case of [PING](https://nda.nih.gov/edit_collection.html?id=2607), the answer is **No**.

> Are you aware of any export restrictions regarding the data?

Just select **No**.

<img width="638" alt="fifth-step" src="https://user-images.githubusercontent.com/53891017/127527738-b29342d2-8bce-4b09-a89e-1eec9251f700.png">

## Step 3 : Select faculty member, business administrator and department
<img width="638" alt="sixth-step" src="https://user-images.githubusercontent.com/53891017/127528655-0d26b3e9-26f6-45bc-b658-7014418698e3.png">

In our case, faculty member is Theodore Satterthwaite, and the department is Neuropsychiatry.
<img width="912" alt="sixth-step-filled-out" src="https://user-images.githubusercontent.com/53891017/127531608-6c2717bb-1925-4ac5-bdff-950027b0f3da.png">

Consult the team for business administrator.

## Step 4 : Upload research plan 

Consult the team to come up with a research plan. This should be a short paragraph. You can either enter that plan in the blank field or upload it as an attachment.

<img width="638" alt="seventh-step" src="https://user-images.githubusercontent.com/53891017/127531769-3cb47b34-8834-469e-888f-9206c974fcef.png">

> _This request is associated with_
> +	_Federally sponsored/federal flow through research_
> +	_Corporate sponsored clinical trial or human subjects research_
> +	_Foundations/other non-profit sponsored research_
> +	_Other corporate sponsored research_
> +	_Other_

[PING](https://nda.nih.gov/edit_collection.html?id=2607) is funded by the National Institute of Mental Health (NIMH) which is a federal agency. Hence we select **Federally sponsored/federal flow through research**
	
> _Are your requests (materials, data, equipment, confidential information , services and/or collaboration) related or connected to a sponsored research agreement (SRA), a clinical trial agreement (CTA), a government or grant funded project, or will it be charged to a fund?_
> + _Yes_
> + _No_
	
In the case of [PING](https://nda.nih.gov/edit_collection.html?id=2607), the data request is for the purpose of scientific research. The research is neither related nor connected to a sponsored research agreement (SRA), a clinical trial agreement (CTA), a government or grant funded project. Hence we select **No**


> _What is the likelihood of an invention resulting from the research?_
> + _May possibly result in an invention_
> + _Is likely to result in an invention_
> +	_Is unlikely to result in an invention_


In the case of [PING](https://nda.nih.gov/edit_collection.html?id=2607), the data request is for the purpose of scientific research that would not lead to any invention.**

> _Is the research related to any of your previous or pending disclosures of inventions?_
> + _Yes_
> +	_No_

In the case of [PING](https://nda.nih.gov/edit_collection.html?id=2607), the data request is for the purpose of scientific research that is not related to any disclosures of inventions. Hence we select **No**

**Modify as necessary for your specific requested dataset.**

## Step 5 : Fill out data information

Below is how you would fill out the data information for [PING](https://nda.nih.gov/edit_collection.html?id=2607).

**Modify as necessary for your specific requested dataset.**

<img width="638" alt="eighth-step" src="https://user-images.githubusercontent.com/53891017/127549332-898c308e-be85-4dad-a181-01039c70fa1a.png">


## Step 6 : Upload data use agreement

Upload the **signed and dated** data use agreement form that you prepared at the beginning by clicking **Upload outside party agreement**.

<img width="638" alt="ninth-step" src="https://user-images.githubusercontent.com/53891017/127549697-76125b82-cdb1-4e8d-9dc6-78ebaed9bfaf.png">

## Step 7 : Final submission

Select **No** for the question and you can click on **submit**. 

<img width="638" alt="tenth-step" src="https://user-images.githubusercontent.com/53891017/127550016-d2beba73-364c-45e6-8ee3-efde3c8d4c7c.png">

## Step 8: Wait for approval from the Office of Research Services

Just relax and wait for a final approval email to pop up in your inbox. The subject line would read like `MTA/NMA (58028/00): Request fully executed`.

## Step 9: Contact the Lead Recipient 

Per the new NDA policy, The only way to properly submit a DUC is for the Lead Recipient to upload the document to the appropriate DAR on their Data Permissions dashboard (https://nda.nih.gov/user/dashboard/data_permissions.html). 

Now you should contact the Lead Recipient for the DUC to execute the following steps:

+ visit the Data Permissions dashboard (https://nda.nih.gov/user/dashboard/data_permissions.html)

+ click 'Reapply for Access' under the 'Actions' dropdown for the Data access request

+ locate the updated DUC file

+ upload the DUC to Data Access Request.

Once you receive the `Permission Approved` Email from NIMH, pat yourself on the back and enjoy a moment of relief. However, you are not yet done and please read on.


# Accessing the Data

## Accept the Terms of Data Use

After you've been granted access, you need to log in to the [NDA website](https://nda.nih.gov/) to review and accept terms of data use. The prompt window should look like below:
<img width="804" alt="NDA_Screenshot" src="https://user-images.githubusercontent.com/53891017/142075932-9ec48404-3fb7-4647-9634-1f6464a185aa.png">

Make sure you click on `Accept`.

## Obtain AWS Credentials

Note 1: For security purposes, the AWS access key ID, AWS secret access key and AWS session token referenced below are all FAKE values. Please replace them with your real ID/key.

Note 2: This tutorial is partially adapted from the NDA's tutorial [How to Access S3 Objects](https://github.com/NDAR/ndar_toolkit/blob/master/how_to_access_s3_objets.md).

### Step 1: Download a copy of the NDA download manager 

The command line downdownload manager is written in Java and allows for the automatic download of files. We can use `wget` to retrieve the program from the NIH web server.
  ```
  wget https://ndar.nih.gov/jnlps/download_manager_client/downloadmanager.zip
  ```
### Step 2: Unzip the download manager
 Since the downloaded program is a zipped file, we would need to unzip the program to use the download manager. 
  
  ```
  unzip downloadmanager.zip
  ```

### Step 3: Use the command-line download manager to generate temporary Amazon S3 security credentials

We specify the name of the output file `awskeys.txt` with the `-g` flag.
  ```
  java -jar downloadmanager.jar -g awskeys.txt
  ```

You will be prompted for your ndar username and password, after which you will be able to find your keys in the file `awskeys.txt`
  ```
  cat awskeys.txt
  ```
You will see something like below from your `awskeys.txt` file.
  ```
  accessKey=xxxxx
secretKey=xxxxx
sessionToken=xxxxx
expirationDate=xxxxx
  ```


### Step 4: Export the AWS S3 credentials to your working directory

For instance, navigate to `~/.aws/credentials` and paste in the `awskeys.txt` according to the format below:


```
[NDAR]
aws_access_key_id = xxxxx[copy and paste the value of accessKey in `awskeys.txt`]
aws_secret_access_key = xxxxx[copy and paste the value of secretKey in `awskeys.txt`]
aws_session_token = xxxxx[copy and paste the value of sessionToken in `awskeys.txt`]
```

Now you should be good to go! Shoot us an email if you still run into issues.
